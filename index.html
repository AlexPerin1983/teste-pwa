<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de M² e Orçamento de Películas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@700&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <link rel="icon" href="icons/peliqueiros.png" type="image/png">
    <link rel="manifest" href="/teste-pwa/manifest.json">
    <meta name="theme-color" content="#000000">

    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-color-dark: #45a049;
            --secondary-color: #FFC107;
            --background-color: #f0f0f0;
            --text-color: #333;
            --text-color-light: #666;
            --border-color: #ddd;
            --border-radius: 8px;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --font-size-sm: 0.9rem;
            --font-size-md: 1rem;
            --font-size-lg: 1.2rem;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(to right, #e0e0e0, #ffffff, #e0e0e0);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: var(--font-size-md);
            transition: border-color var(--transition-speed);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
        }

        .btn {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius);
            font-size: var(--font-size-md);
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-color-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #e6ac00;
        }

        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .popup-content {
            background-color: white;
            padding: var(--spacing-lg);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: inline-block;
            margin-right: var(--spacing-sm);
            cursor: pointer;
        }

        #logoPreview {
            max-width: 100%;
            max-height: 100px;
            margin-top: var(--spacing-sm);
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }

            .popup-content {
                max-width: 90%;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-r from-blue-50 via-white to-blue-50 text-gray-700 min-h-screen flex items-center justify-center font-roboto">
    <div class="container">
        <div class="card">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-montserrat text-gray-900 font-bold">Calculadora de M² e Orçamento</h1>
            </div>

            <div id="verificacaoIcon" class="hidden fixed top-4 right-4 text-green-500" title="Aplicativo Verificado">
                <i class="fas fa-check-circle text-3xl"></i>
            </div>

            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <select id="clienteSelect" class="form-control" onchange="onClienteChange()">
                        <option value="">Selecione um cliente</option>
                    </select>
                    <button id="addNewClienteBtn" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>

                <div id="editIconContainer" class="hidden flex justify-end space-x-2">
                    <button onclick="abrirPopup('editar')" class="btn btn-secondary">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="confirmClearMedidas()" class="btn btn-secondary">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button onclick="abrirPopupUsuario()" class="btn btn-secondary">
                        <i class="fas fa-user-cog"></i>
                    </button>
                </div>
                <div id="medidasContainer" class="space-y-4"></div>

                <div id="resultado" class="text-right text-2xl font-bold text-green-500">Total M²: 0,00 | Preço Total:
                    R$ 0,00</div>

                <div class="grid grid-cols-2 gap-4">
                    <button class="btn btn-primary" onclick="addMedidaGroup(true)">
                        Adicionar Medida
                    </button>
                    <button class="btn btn-secondary" onclick="duplicarMedidas()">
                        Duplicar Medidas
                    </button>
                    <button class="btn btn-primary" id="generatePdfButton">
                        Gerar PDF
                    </button>
                    <button class="btn btn-secondary" onclick="copyShareURL()">
                        Compartilhar URL
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Informações do Usuário -->
    <div id="popupUsuario" class="popup">
        <div class="popup-content">
            <h2 class="text-xl font-semibold mb-4">Cadastro de Usuário</h2>
            <form id="userForm" class="space-y-4">
                <div class="form-group">
                    <label for="logo">Logotipo:</label>
                    <input type="file" id="logo" accept="image/*" class="form-control">
                    <img id="logoPreview" src="" alt="Preview do logotipo" style="display: none;">
                </div>
                <div class="form-group">
                    <label>Cores:</label>
                    <div class="flex items-center space-x-2">
                        <div>
                            <span>Primária:</span>
                            <div id="primaryColorPreview" class="color-preview"></div>
                            <input type="color" id="primaryColor" style="display: none;">
                        </div>
                        <div>
                            <span>Secundária:</span>
                            <div id="secondaryColorPreview" class="color-preview"></div>
                            <input type="color" id="secondaryColor" style="display: none;">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="name">Nome:</label>
                    <input type="text" id="name" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="companyName">Nome da empresa:</label>
                    <input type="text" id="companyName" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="phone">Telefone:</label>
                    <input type="tel" id="phone" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="address">Endereço:</label>
                    <input type="text" id="address" required class="form-control">
                </div>
                <div class="form-group">
                    <label for="cpfCnpj">CPF/CNPJ:</label>
                    <input type="text" id="cpfCnpj" required class="form-control">
                </div>
                <button type="submit" class="btn btn-primary w-full">Salvar</button>
            </form>
        </div>
    </div>

    <!-- Modal para Adicionar/Editar Cliente -->
    <div id="popupCliente" class="popup">
        <div class="popup-content">
            <span class="close text-2xl font-bold cursor-pointer absolute top-2 right-2" onclick="fecharPopup()">&times;</span>
            <h2 id="popupTitulo" class="text-xl font-semibold mb-4">Adicionar Novo Cliente</h2>
            <form id="clienteForm" class="space-y-4">
                <input type="text" id="popupClienteNome" class="form-control" placeholder="Nome do Cliente" required>
                <input type="tel" id="popupClienteTelefone" class="form-control" placeholder="Telefone" inputmode="tel" required>
                <input type="text" id="popupClienteEndereco" class="form-control" placeholder="Endereço" required>
                <input type="text" id="popupClienteCPF" class="form-control" placeholder="CPF" inputmode="numeric">
                <input type="text" id="popupClienteCNPJ" class="form-control" placeholder="CNPJ" inputmode="numeric">
                <button type="submit" id="popupClienteBtnSalvar" class="btn btn-primary w-full">
                    Salvar Cliente
                </button>
            </form>
        </div>
    </div>

    <script>
        // Registro do Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/teste-pwa/service-worker.js')
                .then(function (registration) {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(function (error) {
                    console.log('Falha ao registrar o Service Worker:', error);
                });
        }

        // Lista de películas e clientes
        const peliculas = [
            { nome: "Window Blue Performance", preco: 240 },
            { nome: "Window BLUE 70", preco: 200 },
            { nome: "Carbono Window Usa", preco: 100 },
            { nome: "Profissional", preco: 90 },
            { nome: "Silver 10 Externa", preco: 280 },
            { nome: "Prata Reflecta", preco: 120 },
            { nome: "Prata Reflecta 15", preco: 120 },
            { nome: "Origin Carbon", preco: 120 },
            { nome: "Vinil Blackout", preco: 130 },
            { nome: "Vinil Jateado", preco: 120 },
            { nome: "Vinil Perfurado", preco: 85 },
            { nome: "Window Premium", preco: 160 }
        ];

        let clientes = [];
        let clienteSelecionado = '';
        const clienteSelect = document.getElementById('clienteSelect');

        function atualizarIconeVerificacao(status) {
            const icone = document.getElementById('verificacaoIcon');
            if (status === 'ativado') {
                icone.classList.remove('hidden');
            } else {
                icone.classList.add('hidden');
            }
        }

        function abrirPopup(acao) {
            fecharTodosPopups();
            const popupCliente = document.getElementById('popupCliente');
            const popupTitulo = document.getElementById('popupTitulo');

            if (!popupCliente || !popupTitulo) {
                console.error("Elementos do popup não encontrados");
                return;
            }

            if (acao === 'adicionar') {
                popupTitulo.innerText = 'Adicionar Novo Cliente';
                limparCamposPopup();
                clienteSelecionado = '';
            } else if (acao === 'editar') {
                popupTitulo.innerText = 'Editar Cliente';
                carregarDadosCliente();
                clienteSelecionado = clienteSelect.value;
            }

            popupCliente.style.display = 'flex';
        }

        function fecharTodosPopups() {
            const popups = document.querySelectorAll('.popup');
            popups.forEach(popup => {
                popup.style.display = 'none';
            });
        }

        function limparCamposPopup() {
            document.getElementById('popupClienteNome').value = '';
            document.getElementById('popupClienteTelefone').value = '';
            document.getElementById('popupClienteEndereco').value = '';
            document.getElementById('popupClienteCPF').value = '';
            document.getElementById('popupClienteCNPJ').value = '';
        }

        async function carregarInformacoesUsuario() {
            const info = await obterInformacoesUsuarioDoIndexedDB();
            if (info) {
                document.getElementById('name').value = info.nome || '';
                document.getElementById('companyName').value = info.empresa || '';
                document.getElementById('phone').value = info.telefone || '';
                document.getElementById('email').value = info.email || '';
                document.getElementById('address').value = info.endereco || '';
                document.getElementById('cpfCnpj').value = info.cpfCnpj || '';

                if (info.logo) {
                    const logoPreview = document.getElementById('logoPreview');
                    logoPreview.src = info.logo;
                    logoPreview.style.display = 'block';
                }

                if (info.cores) {
                    document.getElementById('primaryColorPreview').style.backgroundColor = info.cores.primaria;
                    document.getElementById('secondaryColorPreview').style.backgroundColor = info.cores.secundaria;
                    document.getElementById('primaryColor').value = info.cores.primaria;
                    document.getElementById('secondaryColor').value = info.cores.secundaria;
                }
            }
        }

        function fecharPopupUsuario() {
            document.getElementById('popupUsuario').style.display = 'none';
        }

        async function salvarInformacoesUsuario(event) {
            event.preventDefault();

            const nome = document.getElementById('name').value;
            const empresa = document.getElementById('companyName').value;
            const telefone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const endereco = document.getElementById('address').value;
            const cpfCnpj = document.getElementById('cpfCnpj').value;
            const logoFile = document.getElementById('logo').files[0];
            const corPrimaria = document.getElementById('primaryColor').value;
            const corSecundaria = document.getElementById('secondaryColor').value;

            let logoUrl = '';
            if (logoFile) {
                logoUrl = await converterImagemParaBase64(logoFile);
            } else {
                const infoExistente = await obterInformacoesUsuarioDoIndexedDB();
                if (infoExistente && infoExistente.logo) {
                    logoUrl = infoExistente.logo;
                }
            }

            const infoUsuario = {
                id: 'info',
                nome,
                empresa,
                telefone,
                email,
                endereco,
                cpfCnpj,
                logo: logoUrl,
                cores: {
                    primaria: corPrimaria,
                    secundaria: corSecundaria
                }
            };

            try {
                await salvarInformacoesUsuarioNoIndexedDB(infoUsuario);
                fecharPopupUsuario();
                alert('Informações do usuário atualizadas com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar informações:', error);
                alert('Erro ao atualizar informações. Por favor, tente novamente.');
            }
        }

        function converterImagemParaBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function abrirIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ClientesDB', 3);

                request.onerror = event => {
                    console.error('Erro ao abrir o IndexedDB:', event);
                    reject(event);
                };

                request.onsuccess = event => {
                    resolve(event.target.result);
                };

                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('usuario')) {
                        db.createObjectStore('usuario', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('clientes')) {
                        db.createObjectStore('clientes', { keyPath: 'nome' });
                    }
                    if (!db.objectStoreNames.contains('medidas')) {
                        db.createObjectStore('medidas', { keyPath: 'cliente' });
                    }
                    if (!db.objectStoreNames.contains('verificacao')) {
                        db.createObjectStore('verificacao', { keyPath: 'id' });
                    }
                };
            });
        }

        async function obterInformacoesUsuarioDoIndexedDB() {
            const db = await abrirIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['usuario'], 'readonly');
                const objectStore = transaction.objectStore('usuario');
                const request = objectStore.get('info');

                request.onerror = event => {
                    console.error('Erro ao obter informações do usuário:', event);
                    reject(event);
                };

                request.onsuccess = event => {
                    resolve(event.target.result);
                };
            });
        }

        async function salvarInformacoesUsuarioNoIndexedDB(infoUsuario) {
            const db = await abrirIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['usuario'], 'readwrite');
                const objectStore = transaction.objectStore('usuario');
                const request = objectStore.put(infoUsuario);

                request.onerror = event => {
                    console.error('Erro ao salvar no IndexedDB:', event);
                    reject(event);
                };

                request.onsuccess = event => {
                    resolve(event.target.result);
                };
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            await carregarClientes();
            document.getElementById('generatePdfButton').addEventListener('click', () => verificarAtivacaoAntes(generatePDF_v3_0));

            const status = await verificarStatusAplicativo();
            atualizarStatusAplicativoSilenciosamente(status);

            const userForm = document.getElementById('userForm');
            if (userForm) {
                userForm.addEventListener('submit', salvarInformacoesUsuario);
            }

            const addNewClienteBtn = document.getElementById('addNewClienteBtn');
            if (addNewClienteBtn) {
                addNewClienteBtn.addEventListener('click', () => abrirPopup('adicionar'));
            }

            const clienteForm = document.getElementById('clienteForm');
            if (clienteForm) {
                clienteForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    await salvarCliente();
                });
            }

            setupColorPickers();
            setupInputMasks();
            setupLogoInput();
            setupCloseButtons();

            clienteSelect.addEventListener('change', onClienteChange);
        });

        function atualizarStatusAplicativoSilenciosamente(status) {
            switch (status.status) {
                case 'novo':
                    iniciarTesteGratis();
                    atualizarIconeVerificacao('nao_ativado');
                    break;
                case 'em_teste':
                    atualizarIconeVerificacao('nao_ativado');
                    // Opcionalmente, atualizar algum elemento da UI para mostrar os dias restantes
                    break;
                case 'expirado':
                    atualizarIconeVerificacao('nao_ativado');
                    // Opcionalmente, atualizar a UI para indicar que o teste expirou
                    break;
                case 'ativado':
                    atualizarIconeVerificacao('ativado');
                    break;
                default:
                    console.error('Erro ao verificar o status do aplicativo');
                    atualizarIconeVerificacao('nao_ativado');
            }
        }

        function setupColorPickers() {
            const primaryColorInput = document.getElementById('primaryColor');
            const secondaryColorInput = document.getElementById('secondaryColor');
            const primaryColorPreview = document.getElementById('primaryColorPreview');
            const secondaryColorPreview = document.getElementById('secondaryColorPreview');

            if (primaryColorInput && primaryColorPreview) {
                primaryColorInput.addEventListener('input', (e) => {
                    primaryColorPreview.style.backgroundColor = e.target.value;
                });
                primaryColorPreview.addEventListener('click', () => primaryColorInput.click());
            }

            if (secondaryColorInput && secondaryColorPreview) {
                secondaryColorInput.addEventListener('input', (e) => {
                    secondaryColorPreview.style.backgroundColor = e.target.value;
                });
                secondaryColorPreview.addEventListener('click', () => secondaryColorInput.click());
            }
        }

        function setupInputMasks() {
            $('#popupClienteTelefone, #telefoneClienteInput').mask('(00) 00000-0000');
            $('#popupClienteCPF, #cpfClienteInput').mask('000.000.000-00');
            $('#popupClienteCNPJ, #cnpjClienteInput').mask('00.000.000/0000-00');
        }

        function setupLogoInput() {
            const logoInput = document.getElementById('logo');
            if (logoInput) {
                logoInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const logoPreview = document.getElementById('logoPreview');
                            logoPreview.src = e.target.result;
                            logoPreview.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        function setupCloseButtons() {
            const closeButtons = document.querySelectorAll('.close');
            closeButtons.forEach(button => {
                button.addEventListener('click', fecharTodosPopups);
            });
        }

        async function carregarDadosCliente() {
            const cliente = await obterClienteDoIndexedDB(clienteSelect.value);
            if (cliente) {
                document.getElementById('popupClienteNome').value = cliente.nome;
                document.getElementById('popupClienteTelefone').value = cliente.telefone;
                document.getElementById('popupClienteEndereco').value = cliente.endereco;
                document.getElementById('popupClienteCPF').value = cliente.cpf;
                document.getElementById('popupClienteCNPJ').value = cliente.cnpj;
            }
        }

        async function salvarCliente() {
            const nome = document.getElementById('popupClienteNome').value.trim();
            const telefone = document.getElementById('popupClienteTelefone').value.trim();
            const endereco = document.getElementById('popupClienteEndereco').value.trim();
            const cpf = document.getElementById('popupClienteCPF').value.trim();
            const cnpj = document.getElementById('popupClienteCNPJ').value.trim();

            if (nome && (clienteSelecionado === '' || nome === clienteSelecionado || !(await verificarClienteExistente(nome)))) {
                const novoCliente = { nome, telefone, endereco, cpf, cnpj };

                try {
                    if (clienteSelecionado) {
                        await atualizarClienteNoIndexedDB(clienteSelecionado, novoCliente);
                        const medidasExistentes = await obterMedidasDoIndexedDB(clienteSelecionado);
                        if (medidasExistentes) {
                            await salvarMedidasNoIndexedDB(nome, medidasExistentes);
                            if (nome !== clienteSelecionado) {
                                await removerMedidasDoIndexedDB(clienteSelecionado);
                            }
                        }
                    } else {
                        await salvarClienteNoIndexedDB(novoCliente);
                    }

                    await carregarClientes(nome);
                    fecharPopup();
                    alert("Cliente salvo com sucesso!");
                } catch (error) {
                    console.error("Erro ao salvar cliente:", error);
                    alert("Ocorreu um erro ao salvar o cliente. Por favor, tente novamente.");
                }
            } else {
                alert("O nome do cliente já existe ou não foi informado.");
            }
        }

        async function carregarClientes(clienteSelecionado = '') {
            clientes = await obterTodosClientesDoIndexedDB();
            clienteSelect.innerHTML = '<option value="">Selecione um cliente</option>';
            if (clientes.length > 0) {
                clienteSelect.classList.remove('hidden');
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.nome;
                    option.textContent = cliente.nome;
                    clienteSelect.appendChild(option);
                });

                if (clienteSelecionado) {
                    clienteSelect.value = clienteSelecionado;
                } else if (clientes.length > 0) {
                    clienteSelect.value = clientes[0].nome;
                }

                loadMedidas();
                mostrarEditIconContainer(true);
            } else {
                clienteSelect.classList.add('hidden');
                mostrarEditIconContainer(false);
            }
        }

        function onClienteChange() {
            clienteSelecionado = clienteSelect.value;
            loadMedidas();
            if (clienteSelecionado) {
                mostrarEditIconContainer(true);
            } else {
                mostrarEditIconContainer(false);
            }
        }

        function mostrarEditIconContainer(exibir) {
            const editIconContainer = document.getElementById('editIconContainer');
            if (exibir && clienteSelect.value) {
                editIconContainer.classList.remove('hidden');
            } else {
                editIconContainer.classList.add('hidden');
            }
        }

        function fecharPopup() {
            const popupCliente = document.getElementById('popupCliente');
            if (popupCliente) {
                popupCliente.style.display = 'none';
            }
        }

        function confirmClearMedidas() {
            if (confirm("Tem certeza que deseja apagar este cliente e suas medidas?")) {
                clearMedidas();
            }
        }

        async function clearMedidas() {
            const cliente = clienteSelect.value;
            if (!cliente) {
                alert('Selecione um cliente.');
                return;
            }

            await removerMedidasDoIndexedDB(cliente);
            await removerClienteDoIndexedDB(cliente);

            await carregarClientes();
            document.getElementById('medidasContainer').innerHTML = '';

            if (clientes.length > 0) {
                clienteSelect.value = clientes[0].nome;
                loadMedidas();
            } else {
                clienteSelect.value = '';
            }

            calculateTotal();
        }

        async function saveMedidas() {
            const cliente = clienteSelect.value;
            if (!cliente) return;

            const medidaGroups = document.querySelectorAll('#medidasContainer > div');
            const medidas = Array.from(medidaGroups).map(group => ({
                largura: group.querySelector('.largura-input').value,
                altura: group.querySelector('.altura-input').value,
                quantidade: group.querySelector('.quantidade-input').value,
                ambiente: group.querySelector('.additional-fields select:nth-of-type(1)').value,
                tipoAplicacao: group.querySelector('.additional-fields select:nth-of-type(2)').value,
                pelicula: group.querySelector('.pelicula-select').value
            }));

            await salvarMedidasNoIndexedDB(cliente, medidas);
        }

        async function loadMedidas() {
            const cliente = clienteSelect.value;
            const savedMedidas = await obterMedidasDoIndexedDB(cliente);
            const medidasContainer = document.getElementById('medidasContainer');
            medidasContainer.innerHTML = '';

            if (savedMedidas) {
                savedMedidas.forEach(medida => {
                    addMedidaGroup(false, medida.largura, medida.altura, medida.quantidade, true, medida.ambiente, medida.tipoAplicacao, medida.pelicula);
                });
            } else {
                addMedidaGroup(true);
            }
            calculateTotal();
        }

        function addMedidaGroup(isFirst, largura = '', altura = '', quantidade = 1, isChecked = true, ambiente = '', tipoAplicacao = '', peliculaSelecionada = '') {
            const container = document.getElementById('medidasContainer');
            const medidaGroup = document.createElement('div');
            medidaGroup.classList.add('bg-white', 'shadow-md', 'rounded-lg', 'p-4', 'space-y-2', 'mb-4');

            medidaGroup.innerHTML = `
                <div class="flex items-center space-x-2 mb-2">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleInputs(this)" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-0">
                    <input type="number" placeholder="L" value="${largura}" class="w-1/4 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 largura-input" oninput="atualizarTotal(this)" maxlength="3">
                    <input type="number" placeholder="A" value="${altura}" class="w-1/4 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 altura-input" oninput="atualizarTotal(this)" maxlength="3">
                    <input type="number" placeholder="Q" value="${quantidade}" class="w-1/4 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 quantidade-input" oninput="atualizarTotal(this)" maxlength="3">
                    <input type="text" placeholder="M²" disabled class="w-1/4 p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                </div>
                <div class="flex items-center space-x-2">
                    <select class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 pelicula-select" onchange="calculateTotal()">
                        ${peliculas.map(p => `<option value="${p.nome}" ${p.nome === peliculaSelecionada ? 'selected' : ''}>${p.nome}</option>`).join('')}
                    </select>
                    <button class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow-md" onclick="duplicarGrupo(this)">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-md" onclick="toggleAdditionalFields(this)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-md" onclick="deleteMedidaGroup(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="additional-fields hidden mt-2">
                    <select onchange="calculateTotal()" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                        <option value="">Ambiente</option>
                        <option value="Sala de estar" ${ambiente === "Sala de estar" ? 'selected' : ''}>Sala de estar</option>
                        <option value="Sala de jantar" ${ambiente === "Sala de jantar" ? 'selected' : ''}>Sala de jantar</option>
                        <option value="Outros" ${ambiente === "Outros" ? 'selected' : ''}>Outros</option>
                    </select>
                    <select onchange="calculateTotal()" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                        <option value="">Tipo de Aplicação</option>
                        <option value="Vidro Fixo" ${tipoAplicacao === "Vidro Fixo" ? 'selected' : ''}>Vidro Fixo</option>
                        <option value="Janela Padrão" ${tipoAplicacao === "Janela Padrão" ? 'selected' : ''}>Janela Padrão</option>
                        <option value="Balcão" ${tipoAplicacao === "Balcão" ? 'selected' : ''}>Balcão</option>
                        <option value="Outras" ${tipoAplicacao === "Outras" ? 'selected' : ''}>Outras</option>
                    </select>
                </div>
            `;
            container.appendChild(medidaGroup);

            const larguraInput = medidaGroup.querySelector('.largura-input');
            const alturaInput = medidaGroup.querySelector('.altura-input');
            const quantidadeInput = medidaGroup.querySelector('.quantidade-input');

            larguraInput.addEventListener('input', function () {
                if (larguraInput.value.length >= 4) {
                    alturaInput.focus();
                }
            });

            alturaInput.addEventListener('input', function () {
                if (alturaInput.value.length >= 4) {
                    quantidadeInput.focus();
                    setTimeout(() => {
                        const length = quantidadeInput.value.length;
                        quantidadeInput.setSelectionRange(length, length);
                    }, 0);
                }
            });

            if (isFirst) {
                larguraInput.focus();
            }

            calculateTotal();
        }

        function atualizarTotal(input) {
            const group = input.closest('.bg-white');
            const largura = parseFloat(group.querySelector('.largura-input').value) || 0;
            const altura = parseFloat(group.querySelector('.altura-input').value) || 0;
            const quantidade = parseInt(group.querySelector('.quantidade-input').value) || 0;
            const totalM2 = largura * altura * quantidade;

            group.querySelector('input[placeholder="M²"]').value = totalM2.toFixed(2);
            calculateTotal();
        }

        function duplicarGrupo(button) {
            const group = button.closest('.bg-white');
            const largura = group.querySelector('.largura-input').value || '';
            const altura = group.querySelector('.altura-input').value || '';
            const quantidade = group.querySelector('.quantidade-input').value || '';
            const ambiente = group.querySelector('.additional-fields select:nth-of-type(1)').value || '';
            const tipoAplicacao = group.querySelector('.additional-fields select:nth-of-type(2)').value || '';
            const peliculaSelecionada = group.querySelector('.pelicula-select').value || '';

            addMedidaGroup(false, largura, altura, quantidade, true, ambiente, tipoAplicacao, peliculaSelecionada);
            calculateTotal();
        }

        function duplicarMedidas() {
            const medidaGroups = document.querySelectorAll('#medidasContainer > div');
            medidaGroups.forEach(group => {
                const largura = group.querySelector('.largura-input').value || '';
                const altura = group.querySelector('.altura-input').value || '';
                const quantidade = group.querySelector('.quantidade-input').value || '';
                const ambiente = group.querySelector('.additional-fields select:nth-of-type(1)').value || '';
                const tipoAplicacao = group.querySelector('.additional-fields select:nth-of-type(2)').value || '';
                const peliculaSelecionada = group.querySelector('.pelicula-select').value || '';

                addMedidaGroup(false, largura, altura, quantidade, true, ambiente, tipoAplicacao, peliculaSelecionada);
            });
            calculateTotal();
        }

        function deleteMedidaGroup(button) {
            if (confirm('Tem certeza que deseja excluir este grupo de medidas?')) {
                button.closest('.bg-white').remove();
                calculateTotal();
                saveMedidas();
            }
        }

        function calculateTotal() {
            const medidaGroups = document.querySelectorAll('#medidasContainer > div');
            let totalM2 = 0;
            let precoTotal = 0;

            medidaGroups.forEach(group => {
                const isChecked = group.querySelector('input[type="checkbox"]').checked;
                const largura = parseFloat(group.querySelector('.largura-input').value) || 0;
                const altura = parseFloat(group.querySelector('.altura-input').value) || 0;
                const quantidade = parseInt(group.querySelector('.quantidade-input').value) || 0;
                const peliculaNome = group.querySelector('.pelicula-select').value;
                const pelicula = peliculas.find(p => p.nome === peliculaNome);

                const area = largura * altura * quantidade;
                const preco = pelicula ? area * pelicula.preco : 0;

                if (isChecked) {
                    totalM2 += area;
                    precoTotal += preco;
                    group.querySelector('input[placeholder="M²"]').value = area.toFixed(2);
                } else {
                    group.querySelector('input[placeholder="M²"]').value = '0.00';
                }
            });

            document.getElementById('resultado').innerText = `Total M²: ${totalM2.toFixed(2)} | Preço Total: R$ ${precoTotal.toFixed(2)}`;
            saveMedidas();
        }

        function toggleAdditionalFields(button) {
            const fields = button.closest('.bg-white').querySelector('.additional-fields');
            if (fields.classList.contains('hidden')) {
                fields.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                fields.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        function toggleInputs(checkbox) {
            const inputs = checkbox.closest('.bg-white').querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input !== checkbox) {
                    input.disabled = !checkbox.checked;
                }
            });
            calculateTotal();
        }

        function copyShareURL() {
            const cliente = clienteSelect.value;
            if (!cliente) {
                alert('Selecione um cliente.');
                return;
            }

            const url = new URL(window.location.href);
            url.searchParams.set('cliente', cliente);
            const shareURL = url.toString();

            navigator.clipboard.writeText(shareURL).then(() => {
                alert('URL copiada para a área de transferência!');
            }, (err) => {
                console.error('Erro ao copiar a URL: ', err);
            });
        }

        const DURACAO_TESTE_GRATIS = 7 * 24 * 60 * 60 * 1000; // 7 dias em milissegundos

        async function verificarStatusAplicativo() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readonly');
            const objectStore = transaction.objectStore('verificacao');
            const request = objectStore.get('status');

            return new Promise((resolve) => {
                request.onsuccess = event => {
                    const result = event.target.result;
                    if (result) {
                        if (result.ativado) {
                            resolve({ status: 'ativado' });
                        } else if (result.inicioTeste) {
                            const agora = new Date().getTime();
                            const fimTeste = new Date(result.inicioTeste).getTime() + DURACAO_TESTE_GRATIS;
                            if (agora < fimTeste) {
                                resolve({ status: 'em_teste', diasRestantes: Math.ceil((fimTeste - agora) / (24 * 60 * 60 * 1000)) });
                            } else {
                                resolve({ status: 'expirado' });
                            }
                        } else {
                            resolve({ status: 'novo' });
                        }
                    } else {
                        resolve({ status: 'novo' });
                    }
                };
                request.onerror = () => resolve({ status: 'erro' });
            });
        }

        async function iniciarTesteGratis() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readwrite');
            const objectStore = transaction.objectStore('verificacao');
            await objectStore.put({ id: 'status', ativado: false, inicioTeste: new Date().toISOString() });
        }

        async function ativarAplicativo() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readwrite');
            const objectStore = transaction.objectStore('verificacao');
            await objectStore.put({ id: 'status', ativado: true });
            atualizarIconeVerificacao('ativado');
        }

        async function salvarClienteNoIndexedDB(cliente) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readwrite');
            const objectStore = transaction.objectStore('clientes');
            return objectStore.put(cliente);
        }

        async function obterTodosClientesDoIndexedDB() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readonly');
            const objectStore = transaction.objectStore('clientes');
            const request = objectStore.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(event.target.result);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function verificarClienteExistente(nome) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readonly');
            const objectStore = transaction.objectStore('clientes');
            const request = objectStore.get(nome);

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(!!event.target.result);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function atualizarClienteNoIndexedDB(clienteSelecionado, novoCliente) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readwrite');
            const objectStore = transaction.objectStore('clientes');
            await objectStore.delete(clienteSelecionado);
            return objectStore.put(novoCliente);
        }

        async function obterClienteDoIndexedDB(nome) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readonly');
            const objectStore = transaction.objectStore('clientes');
            const request = objectStore.get(nome);

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(event.target.result);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function removerClienteDoIndexedDB(nome) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readwrite');
            const objectStore = transaction.objectStore('clientes');
            return objectStore.delete(nome);
        }

        async function salvarMedidasNoIndexedDB(cliente, medidas) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['medidas'], 'readwrite');
            const objectStore = transaction.objectStore('medidas');
            return objectStore.put({ cliente, medidas });
        }

        async function obterMedidasDoIndexedDB(cliente) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['medidas'], 'readonly');
            const objectStore = transaction.objectStore('medidas');
            const request = objectStore.get(cliente);

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(event.target.result ? event.target.result.medidas : null);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function removerMedidasDoIndexedDB(cliente) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['medidas'], 'readwrite');
            const objectStore = transaction.objectStore('medidas');
            return objectStore.delete(cliente);
        }

        function generatePDF_v3_0() {
            try {
                const clienteNome = clienteSelect.value;
                if (!clienteNome) {
                    alert('Selecione um cliente.');
                    return;
                }

                const cliente = clientes.find(c => c.nome === clienteNome);
                if (!cliente) {
                    alert('Informações do cliente não encontradas.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 15;

                const colors = {
                    primary: [28, 4, 56],
                    secondary: [242, 182, 3],
                    text: [44, 62, 80],
                    lightGray: [236, 240, 241],
                    header: [0, 51, 102]
                };

                function addCover() {
                    doc.setFillColor(245, 245, 245);
                    doc.rect(0, 0, pageWidth, pageHeight, 'F');

                    const barColors = ['#000000', '#1a1a1a', '#333333', '#4d4d4d', '#666666', '#808080', '#999999', '#b3b3b3', '#cccccc', '#e6e6e6'];
                    const barWidth = pageWidth / barColors.length;
                    barColors.forEach((color, index) => {
                        doc.setFillColor(color);
                        doc.rect(index * barWidth, 0, barWidth, 40, 'F');
                    });

                    doc.setTextColor(44, 62, 80);
                    doc.setFont("helvetica", 'bold');
                    doc.setFontSize(18);
                    doc.text(`Cliente: ${cliente.nome}`, margin, 70);

                    doc.setFont("helvetica", 'normal');
                    doc.setFontSize(12);
                    doc.text(`Telefone: ${cliente.telefone}`, margin, 90);
                    doc.text(`Endereço: ${cliente.endereco}`, margin, 105);
                    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, margin, 120);

                    doc.text("VÁLIDO POR 90 DIAS", margin, 135);

                    doc.setDrawColor(41, 128, 185);
                    doc.setLineWidth(1);
                    doc.line(margin, pageHeight - 40, pageWidth - margin, pageHeight - 40);

                    doc.setTextColor(41, 128, 185);
                    doc.setFontSize(12);
                    doc.setFont("helvetica", 'italic');
                    doc.text("Soluções em Películas de Alta Qualidade", pageWidth / 2, pageHeight - 25, { align: 'center' });
                }

                function addFooter() {
                    const footerHeight = 20;
                    const footerY = pageHeight - footerHeight;

                    doc.setFillColor(...colors.primary);
                    doc.rect(0, footerY, pageWidth, footerHeight, 'F');

                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont("helvetica", 'normal');
                    doc.text("FUME JP | (83) 99301-5765 | www.fumejp.com.br", margin, footerY + 8);

                    doc.text(`Página ${doc.internal.getNumberOfPages()}`, pageWidth - margin, footerY + 8, { align: 'right' });
                }

                function addPage() {
                    doc.addPage();
                    addFooter();
                    return margin + 20;
                }

                function addContent() {
                    let y = addPage();

                    function addSectionTitle(title) {
                        if (y > pageHeight - 40) y = addPage();
                        doc.setFillColor(...colors.header);
                        doc.rect(0, y, pageWidth, 30, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(12);
                        doc.setFont("helvetica", 'bold');
                        doc.text(title, margin, y + 12);
                        y += 15;
                    }

                    function addTableHeader() {
                        const headers = ["Item", "Dimensões", "Película", "Ambiente", "Tipo", "Área", "Preço"];
                        const colWidths = [15, 30, 35, 30, 30, 20, 25];

                        doc.setFillColor(...colors.primary);
                        doc.rect(margin, y, pageWidth - 2 * margin, 10, 'F');
                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(9);
                        doc.setFont("helvetica", 'bold');

                        let xOffset = margin;
                        headers.forEach((header, index) => {
                            doc.text(header, xOffset + 2, y + 6.5);
                            xOffset += colWidths[index];
                        });

                        y += 12;
                    }

                    function addMedidaItem(medida, index) {
                        if (y > pageHeight - 40) {
                            y = addPage();
                            addTableHeader();
                        }

                        const largura = medida.querySelector('.largura-input').value || '0';
                        const altura = medida.querySelector('.altura-input').value || '0';
                        const quantidade = medida.querySelector('.quantidade-input').value || '0';
                        const totalM2 = medida.querySelector('input[placeholder="M²"]').value || '0';
                        const ambiente = medida.querySelector('.additional-fields select:first-child').value || '';
                        const tipoAplicacao = medida.querySelector('.additional-fields select:last-child').value || '';
                        const peliculaNome = medida.querySelector('.pelicula-select').value || '';
                        const pelicula = peliculas.find(p => p.nome === peliculaNome);

                        const colWidths = [15, 30, 35, 30, 30, 20, 25];
                        let xOffset = margin;

                        if (index % 2 === 0) {
                            doc.setFillColor(...colors.lightGray);
                        } else {
                            doc.setFillColor(255, 255, 255);
                        }
                        doc.rect(margin, y - 2, pageWidth - 2 * margin, 10, 'F');

                        doc.setTextColor(...colors.text);
                        doc.setFontSize(8);
                        doc.setFont("helvetica", 'normal');

                        doc.text(`${index}`, xOffset + 2, y + 4);
                        xOffset += colWidths[0];
                        doc.text(`${largura}x${altura} (${quantidade})`, xOffset + 2, y + 4);
                        xOffset += colWidths[1];
                        doc.text(peliculaNome, xOffset + 2, y + 4);
                        xOffset += colWidths[2];
                        doc.text(ambiente, xOffset + 2, y + 4);
                        xOffset += colWidths[3];
                        doc.text(tipoAplicacao, xOffset + 2, y + 4);
                        xOffset += colWidths[4];
                        doc.text(`${totalM2} m²`, xOffset + 2, y + 4);
                        xOffset += colWidths[5];

                        if (pelicula) {
                            const preco = (pelicula.preco * parseFloat(totalM2)).toFixed(2);
                            doc.text(`R$ ${preco}`, xOffset + 2, y + 4);
                        }

                        y += 12;
                    }

                    function addTotalSection(peliculaNome, total) {
                        if (y > pageHeight - 30) y = addPage();

                        doc.setFillColor(...colors.secondary);
                        doc.rect(margin, y, pageWidth - 2 * margin, 20, 'F');

                        doc.setTextColor(255, 255, 255);
                        doc.setFontSize(11);
                        doc.setFont("helvetica", 'bold');
                        doc.text(`Total para ${peliculaNome}:`, margin + 5, y + 8);
                        doc.text(`Área Total: ${total.totalM2.toFixed(2)} m²`, margin + 5, y + 15);
                        doc.text(`Preço Total: R$ ${total.precoTotal.toFixed(2)}`, pageWidth - margin - 5, y + 15, { align: 'right' });

                        y += 25;
                    }

                    const medidaGroups = document.querySelectorAll('#medidasContainer > div');
                    const medidasPorPelicula = {};
                    const totaisGerais = { totalM2: 0, precoTotal: 0 };

                    medidaGroups.forEach(group => {
                        const peliculaNome = group.querySelector('.pelicula-select').value || 'Sem Película';
                        if (!medidasPorPelicula[peliculaNome]) {
                            medidasPorPelicula[peliculaNome] = [];
                        }
                        medidasPorPelicula[peliculaNome].push(group);

                        const largura = parseFloat(group.querySelector('.largura-input').value) || 0;
                        const altura = parseFloat(group.querySelector('.altura-input').value) || 0;
                        const quantidade = parseInt(group.querySelector('.quantidade-input').value) || 0;
                        const pelicula = peliculas.find(p => p.nome === peliculaNome);
                        const area = largura * altura * quantidade;
                        const preco = pelicula ? area * pelicula.preco : 0;

                        totaisGerais.totalM2 += area;
                        totaisGerais.precoTotal += preco;
                    });

                    Object.entries(medidasPorPelicula).forEach(([peliculaNome, medidas], index) => {
                        if (index > 0) y = addPage();
                        addSectionTitle(`Orçamento para: ${peliculaNome}`);
                        addTableHeader();
                        medidas.forEach((group, idx) => {
                            addMedidaItem(group, idx + 1);
                        });

                        const totalPelicula = {
                            totalM2: medidas.reduce((sum, group) => sum + (parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0), 0),
                            precoTotal: medidas.reduce((sum, group) => {
                                const area = parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0;
                                const pelicula = peliculas.find(p => p.nome === peliculaNome);
                                return sum + (pelicula ? area * pelicula.preco : 0);
                            }, 0)
                        };

                        addTotalSection(peliculaNome, totalPelicula);
                    });

                    y = addPage();
                    addSectionTitle("Total Geral do Orçamento");
                    addTotalSection("Todas as Películas", totaisGerais);
                }

                addCover();
                addContent();

                doc.save(`orcamento_${cliente.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF. Por favor, verifique o console para mais detalhes.");
            }
        }

        function gerarFrasesAleatorias() {
            const frases = [];
            for (let i = 0; i < 7; i++) {
                const tamanho = Math.floor(Math.random() * 4) + 5; // 5 a 8 caracteres
                let frase = '';
                for (let j = 0; j < tamanho; j++) {
                    frase += String.fromCharCode(Math.floor(Math.random() * 94) + 33); // Caracteres ASCII imprimíveis
                }
                frases.push(frase);
            }
            return frases;
        }

        function extrairCodigoAtivacao(frases) {
            let codigo = '';

            // Sequência 1: Penúltimo caractere (se for letra, incluir também o primeiro)
            let seq1 = frases[0][frases[0].length - 2];
            if (seq1.match(/[a-zA-Z]/)) seq1 = frases[0][0] + seq1;
            codigo += seq1;

            // Sequência 2: Segundo caractere (se for símbolo ou letra minúscula usar terceiro)
            let seq2 = frases[1][1];
            if (seq2.match(/[^a-zA-Z0-9]/) || seq2.match(/[a-z]/)) seq2 = frases[1][2] || '';
            codigo += seq2;

            // Sequência 3: Primeiro caractere (se for número, incluir o segundo)
            let seq3 = frases[2][0];
            if (seq3.match(/[0-9]/)) seq3 += frases[2][1] || '';
            codigo += seq3;

            // Sequência 4: Último caractere (se for número usar o penúltimo)
            let seq4 = frases[3][frases[3].length - 1];
            if (seq4.match(/[0-9]/)) seq4 = frases[3][frases[3].length - 2] || '';
            codigo += seq4;

            // Sequência 5: Segundo caractere (se for letra, incluir o terceiro)
            let seq5 = frases[4][1];
            if (seq5.match(/[a-zA-Z]/)) seq5 += frases[4][2] || '';
            codigo += seq5;

            // Sequência 6: Quinto caractere (se for símbolo, usar o primeiro)
            let seq6 = frases[5][4] || '';
            if (seq6.match(/[^a-zA-Z0-9]/)) seq6 = frases[5][0] || '';
            codigo += seq6;

            // Sequência 7: Quarto caractere (se for letra maiúscula, incluir o último)
            let seq7 = frases[6][3] || '';
            if (seq7.match(/[A-Z]/)) seq7 += frases[6][frases[6].length - 1] || '';
            codigo += seq7;

            return codigo;
        }

        function verificarCodigo(codigoUsuario, frasesOriginais) {
            const codigoCorreto = extrairCodigoAtivacao(frasesOriginais);
            return codigoUsuario === codigoCorreto;
        }

        async function mostrarPopupVerificacao() {
            const frasesGeradas = gerarFrasesAleatorias();
            const codigoCorreto = extrairCodigoAtivacao(frasesGeradas);

            const popupHTML = `
                <div id="popupVerificacao" class="popup">
                    <div class="popup-content">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Período de Teste Expirado</h2>
                        <p>Seu período de teste gratuito expirou. Para continuar usando o aplicativo, por favor, ative-o enviando as seguintes frases para o WhatsApp +5583993015765:</p>
                        <ol class="list-decimal list-inside mb-4">
                            ${frasesGeradas.map(frase => `<li>${frase}</li>`).join('')}
                        </ol>
                        <input type="text" id="codigoAtivacao" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Insira o código de ativação">
                        <button id="verificarCodigo" class="w-full p-3 bg-blue-500 text-white rounded-md">Ativar Aplicativo</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', popupHTML);

            const popupVerificacao = document.getElementById('popupVerificacao');
            popupVerificacao.style.display = 'flex';

            document.getElementById('verificarCodigo').addEventListener('click', async () => {
                const codigoUsuario = document.getElementById('codigoAtivacao').value;
                if (verificarCodigo(codigoUsuario, frasesGeradas)) {
                    await ativarAplicativo();
                    alert('Código correto! Aplicativo ativado com sucesso.');
                    popupVerificacao.remove();
                } else {
                    alert('Código incorreto. Tente novamente.');
                }
            });
        }

        async function verificarAtivacaoAntes(acao) {
            const status = await verificarStatusAplicativo();
            if (status.status === 'ativado' || status.status === 'em_teste') {
                acao();
            } else {
                mostrarPopupVerificacao();
            }
        }

        function abrirPopupUsuario() {
            fecharTodosPopups();
            const popupUsuario = document.getElementById('popupUsuario');
            popupUsuario.style.display = 'flex';
            carregarInformacoesUsuario();
        }

    </script>
</body>
</html>
