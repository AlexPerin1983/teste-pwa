<!DOCTYPE html>
<html lang="pt-BR" class="h-full bg-gradient-to-r from-blue-50 via-white to-blue-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de M² e Orçamento de Películas</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <link rel="icon" href="icons/peliqueiros.png" type="image/png">
    <link rel="manifest" href="/teste-pwa/manifest.json">
    <meta name="theme-color" content="#000000">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    maxHeight: {
                        '70vh': '70vh',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full font-roboto text-gray-700 flex flex-col">
    <div class="flex-grow overflow-auto">
        <div class="container mx-auto px-2 py-6 w-full max-w-4xl">
            <div class="bg-white rounded-xl shadow-lg p-2 sm:p-4 mb-6">
                <!-- Cabeçalho -->
    <div class="mb-4">
        <div class="text-center mb-2">
            <h1 class="text-2xl sm:text-3xl font-montserrat text-gray-900 font-bold">Dos_Peliqueiros</h1>
        </div>
        <div class="flex items-center space-x-2">
            <select id="clienteSelect" class="flex-grow p-2 text-sm border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="onClienteChange()">
                <option value="">Selecione um cliente</option>
            </select>
            <button id="addNewClienteBtn" class="p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 shadow-md sm:hidden">
                <i class="fas fa-user-plus"></i>
            </button>
            <button id="addNewClienteBtnDesktop" class="hidden sm:block w-auto p-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300 shadow-md">
                <i class="fas fa-user-plus mr-2"></i> Adicionar Cliente
            </button>
        </div>
        <div id="editIconContainer" class="hidden flex justify-end space-x-2 mt-2">
            <button onclick="abrirPopup('editar')" class="p-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition duration-300 shadow-sm">
                <i class="fas fa-edit"></i>
            </button>
            <button onclick="confirmClearMedidas()" class="p-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-300 shadow-sm">
                <i class="fas fa-trash-alt"></i>
            </button>
            <button onclick="abrirPopupUsuario()" class="p-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 transition duration-300 shadow-sm">
                <i class="fas fa-user-cog"></i>
            </button>
        </div>
    </div>

                <!-- Conteúdo scrollável (grupos de medidas) -->
                <div id="medidasContainer" class="space-y-2 w-full pb-20 sm:pb-0">
                    <!-- Os grupos de medidas serão inseridos aqui dinamicamente -->
                </div>

                <!-- Resultado e botões para telas maiores -->
                <div class="hidden sm:block mt-4">
                    <div id="resultadoDesktop" class="text-right text-xl sm:text-2xl font-bold text-green-500 mb-4">Total M²: 0,00 | Preço Total: R$ 0,00</div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button onclick="addMedidaGroup(true)" class="w-full p-4 bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-300 shadow-md">
                            Adicionar Medida
                        </button>
                        <button onclick="duplicarMedidas()" class="w-full p-4 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition duration-300 shadow-md">
                            Duplicar Medidas
                        </button>
                        <button id="generatePdfButton" class="w-full p-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-300 shadow-md">
                            Gerar PDF
                        </button>
                        <button onclick="copyShareURL()" class="w-full p-4 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition duration-300 shadow-md">
                            Compartilhar URL
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Rodapé fixo para mobile -->
<div class="sm:hidden fixed bottom-0 left-0 right-0 bg-white bg-opacity-85 shadow-lg border-t border-gray-800">
    <div class="container mx-auto px-2 py-3">
        <div id="resultadoMobile" class="text-center text-lg font-bold text-black-100 mb-2">Total M²: 0,00 | R$ 0,00</div>
        <div class="flex justify-around items-center">
            <button onclick="addMedidaGroup(true)" class="p-2 text-black-100 hover:text-yellow-300 transition duration-300">
                <i class="fas fa-plus-circle text-2xl"></i>
            </button>
            <button onclick="duplicarMedidas()" class="p-2 text-black-100 hover:text-yellow-300 transition duration-300">
                <i class="fas fa-copy text-2xl"></i>
            </button>
            <button id="generatePdfButtonMobile" class="p-2 text-black-100 hover:text-yellow-300  transition duration-300">
                <i class="fas fa-file-pdf text-2xl"></i>
            </button>
            <button onclick="copyShareURL()" class="p-2 text-black-100 hover:text-yellow-300 transition duration-300">
                <i class="fas fa-share-alt text-2xl"></i>
            </button>
        </div>
    </div>
</div>

    <div id="popupUsuario" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center overflow-y-auto py-5">
        <div class="bg-white rounded-lg shadow-lg relative w-full max-w-md m-2">
            <div class="p-6">
                <h2 class="text-xl font-semibold mb-4">Cadastro de Usuário</h2>
                <div class="max-h-70vh overflow-y-auto pr-2">
                    <form id="userForm" class="space-y-4">
                        <div>
                            <label for="logo" class="block text-sm font-medium text-gray-700">Logotipo:</label>
                            <input type="file" id="logo" accept="image/*" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                            <img id="logoPreview" src="" alt="Preview do logotipo" class="mt-2 hidden max-h-20">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cores:</label>
                            <div class="flex items-center space-x-4 mt-1">
                                <div>
                                    <span class="text-sm text-gray-500">Primária:</span>
                                    <div id="primaryColorPreview" class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer"></div>
                                    <input type="color" id="primaryColor" class="hidden">
                                </div>
                                <div>
                                    <span class="text-sm text-gray-500">Secundária:</span>
                                    <div id="secondaryColorPreview" class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer"></div>
                                    <input type="color" id="secondaryColor" class="hidden">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Nome:</label>
                            <input type="text" id="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="companyName" class="block text-sm font-medium text-gray-700">Nome da empresa:</label>
                            <input type="text" id="companyName" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700">Telefone:</label>
                            <input type="tel" id="phone" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700">Email:</label>
                            <input type="email" id="email" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="address" class="block text-sm font-medium text-gray-700">Endereço:</label>
                            <input type="text" id="address" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="cpfCnpj" class="block text-sm font-medium text-gray-700">CPF/CNPJ:</label>
                            <input type="text" id="cpfCnpj" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </form>
                </div>
            </div>
            <div class="px-6 py-3 bg-gray-50 border-t border-gray-200">
                <button type="submit" form="userForm" class="w-full p-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">Salvar</button>
            </div>
        </div>
    </div>

    <div id="popupCliente" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg relative max-w-md w-full">
            <span class="absolute top-2 right-2 text-2xl font-bold cursor-pointer" onclick="fecharPopup()">&times;</span>
            <h2 id="popupTitulo" class="text-xl font-semibold mb-4">Adicionar Novo Cliente</h2>
            <form id="clienteForm" class="space-y-4">
                <input type="text" id="popupClienteNome" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Nome do Cliente" required>
                <input type="tel" id="popupClienteTelefone" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Telefone" inputmode="tel" required>
                <input type="text" id="popupClienteEndereco" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Endereço" required>
                <input type="text" id="popupClienteCPF" class="w-full p-2 border border-gray-300 rounded-md" placeholder="CPF" inputmode="numeric">
                <input type="text" id="popupClienteCNPJ" class="w-full p-2 border border-gray-300 rounded-md" placeholder="CNPJ" inputmode="numeric">
                <button type="submit" id="popupClienteBtnSalvar" class="w-full p-3 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-300">
                    Salvar Cliente
                </button>
            </form>
        </div>
    </div>

    <script>
        // Registro do Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/teste-pwa/service-worker.js')
                .then(function (registration) {
                    console.log('Service Worker registrado com sucesso:', registration);
                })
                .catch(function (error) {
                    console.log('Falha ao registrar o Service Worker:', error);
                });
        }

        // Adicione esta função ao seu JavaScript existente
    function updateResultado(m2, preco) {
        const resultadoDesktop = document.getElementById('resultadoDesktop');
        const resultadoMobile = document.getElementById('resultadoMobile');
        
        resultadoDesktop.textContent = `Total M²: ${m2.toFixed(2)} | Preço Total: R$ ${preco.toFixed(2)}`;
        resultadoMobile.textContent = `Total M²: ${m2.toFixed(2)} | R$ ${preco.toFixed(2)}`;
    }

        function atualizarIconeVerificacao(status) {
            const icone = document.getElementById('verificacaoIcon');
            if (status === 'ativado') {
                icone.classList.remove('hidden');
            } else {
                icone.classList.add('hidden');
            }
        }

        $(document).ready(function () {
            $('#popupClienteTelefone, #telefoneClienteInput').mask('(00) 00000-0000');
            $('#popupClienteCPF, #cpfClienteInput').mask('000.000.000-00');
            $('#popupClienteCNPJ, #cnpjClienteInput').mask('00.000.000/0000-00');
        });

        const peliculas = [
            { nome: "Window Blue Performance", preco: 240 },
            { nome: "Window BLUE 70", preco: 200 },
            { nome: "Carbono Window Usa", preco: 100 },
            { nome: "Profissional", preco: 90 },
            { nome: "Silver 10 Externa", preco: 280 },
            { nome: "Prata Reflecta", preco: 120 },
            { nome: "Prata Reflecta 15", preco: 120 },
            { nome: "Origin Carbon", preco: 120 },
            { nome: "Vinil Blackout", preco: 130 },
            { nome: "Vinil Jateado", preco: 120 },
            { nome: "Vinil Perfurado", preco: 85 },
            { nome: "Window Premium", preco: 160 }
        ];

        let clientes = [];
        let clienteSelecionado = '';
        const clienteSelect = document.getElementById('clienteSelect');

        async function abrirPopup(acao) {
    const popupCliente = document.getElementById('popupCliente');
    const popupTitulo = document.getElementById('popupTitulo');

    if (!popupCliente || !popupTitulo) {
        console.error("Elementos do popup não encontrados");
        return;
    }

    if (acao === 'adicionar') {
        popupTitulo.innerText = 'Adicionar Novo Cliente';
        limparCamposPopup();
        clienteSelecionado = '';
    } else if (acao === 'editar') {
        popupTitulo.innerText = 'Editar Cliente';
        clienteSelecionado = clienteSelect.value;
        console.log("Editando cliente:", clienteSelecionado);
        await carregarDadosCliente(clienteSelecionado);
    }

    popupCliente.classList.remove('hidden');
    popupCliente.style.display = 'flex';
}

        function limparCamposPopup() {
            document.getElementById('popupClienteNome').value = '';
            document.getElementById('popupClienteTelefone').value = '';
            document.getElementById('popupClienteEndereco').value = '';
            document.getElementById('popupClienteCPF').value = '';
            document.getElementById('popupClienteCNPJ').value = '';
        }

        function abrirPopupUsuario() {
    const popupUsuario = document.getElementById('popupUsuario');
    popupUsuario.classList.remove('hidden');
    carregarInformacoesUsuario();
}

        async function carregarInformacoesUsuario() {
    try {
        const info = await obterInformacoesUsuarioDoIndexedDB();
        if (info) {
            console.log('Informações do usuário encontradas no IndexedDB:', info);
            
            document.getElementById('name').value = info.nome || '';
            document.getElementById('companyName').value = info.empresa || '';
            document.getElementById('phone').value = info.telefone || '';
            document.getElementById('email').value = info.email || '';
            document.getElementById('address').value = info.endereco || '';
            document.getElementById('cpfCnpj').value = info.cpfCnpj || '';

            if (info.logo) {
                const logoPreview = document.getElementById('logoPreview');
                logoPreview.src = info.logo;
                logoPreview.style.display = 'block';
            }

            if (info.cores) {
                document.getElementById('primaryColorPreview').style.backgroundColor = info.cores.primaria;
                document.getElementById('secondaryColorPreview').style.backgroundColor = info.cores.secundaria;
                document.getElementById('primaryColor').value = info.cores.primaria;
                document.getElementById('secondaryColor').value = info.cores.secundaria;
            }
        } else {
            console.log('Nenhuma informação de usuário encontrada no IndexedDB');
        }
    } catch (error) {
        console.error('Erro ao carregar informações do usuário:', error);
    }
}

        function fecharPopupUsuario() {
            document.getElementById('popupUsuario').classList.add('hidden');
        }

        async function salvarInformacoesUsuario() {
            const nome = document.getElementById('name').value;
            const empresa = document.getElementById('companyName').value;
            const telefone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const endereco = document.getElementById('address').value;
            const cpfCnpj = document.getElementById('cpfCnpj').value;
            const logoFile = document.getElementById('logo').files[0];
            const corPrimaria = document.getElementById('primaryColor').value;
            const corSecundaria = document.getElementById('secondaryColor').value;

            let logoUrl = '';
            if (logoFile) {
                logoUrl = await converterImagemParaBase64(logoFile);
            } else {
                const infoExistente = await obterInformacoesUsuarioDoIndexedDB();
                if (infoExistente && infoExistente.logo) {
                    logoUrl = infoExistente.logo;
                }
            }

            const infoUsuario = {
                id: 'info',
                nome,
                empresa,
                telefone,
                email,
                endereco,
                cpfCnpj,
                logo: logoUrl,
                cores: {
                    primaria: corPrimaria,
                    secundaria: corSecundaria
                }
            };

            try {
                await salvarInformacoesUsuarioNoIndexedDB(infoUsuario);
                fecharPopupUsuario();
                alert('Informações do usuário atualizadas com sucesso!');
            } catch (error) {
                console.error('Erro ao salvar informações:', error);
                alert('Erro ao atualizar informações. Por favor, tente novamente.');
            }
        }

        function converterImagemParaBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        async function abrirIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('ClientesDB', 3);

                request.onerror = event => {
                    console.error('Erro ao abrir o IndexedDB:', event);
                    reject(event);
                };

                request.onsuccess = event => {
                    resolve(event.target.result);
                };

                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('usuario')) {
                        db.createObjectStore('usuario', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('clientes')) {
                        db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true }); // Atualizado para usar ID
                    }
                    if (!db.objectStoreNames.contains('medidas')) {
                        db.createObjectStore('medidas', { keyPath: 'cliente' });
                    }
                    if (!db.objectStoreNames.contains('verificacao')) {
                        db.createObjectStore('verificacao', { keyPath: 'id' });
                    }
                };
            });
        }

        async function obterInformacoesUsuarioDoIndexedDB() {
            const db = await abrirIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['usuario'], 'readonly');
                const objectStore = transaction.objectStore('usuario');
                const request = objectStore.get('info');

                request.onerror = event => {
                    console.error('Erro ao obter informações do usuário:', event);
                    reject(event);
                };

                request.onsuccess = event => {
                    resolve(event.target.result);
                };
            });
        }

        async function salvarInformacoesUsuarioNoIndexedDB(infoUsuario) {
            const db = await abrirIndexedDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['usuario'], 'readwrite');
                const objectStore = transaction.objectStore('usuario');
                const request = objectStore.put(infoUsuario);

                request.onerror = event => {
                    console.error('Erro ao salvar no IndexedDB:', event);
                    reject(event);
                };

                request.onsuccess = event => {
                    resolve(event.target.result);
                };
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            const salvarInfoUsuarioBtn = document.getElementById('saveButton');
            if (salvarInfoUsuarioBtn) {
                salvarInfoUsuarioBtn.addEventListener('click', salvarInformacoesUsuario);
            }

            const addNewClienteBtn = document.getElementById('addNewClienteBtn');
    const addNewClienteBtnDesktop = document.getElementById('addNewClienteBtnDesktop');

    if (addNewClienteBtn) {
        addNewClienteBtn.addEventListener('click', function () {
            abrirPopup('adicionar');
        });
    }

    if (addNewClienteBtnDesktop) {
        addNewClienteBtnDesktop.addEventListener('click', function () {
            abrirPopup('adicionar');
        });
    }

            const logoUsuario = document.getElementById('logo');
            if (logoUsuario) {
                logoUsuario.addEventListener('change', function (event) {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const previewLogo = document.getElementById('logoPreview');
                            previewLogo.src = e.target.result;
                            previewLogo.style.display = 'block';
                        }
                        reader.readAsDataURL(file);
                    }
                });
            }

            carregarClientes();
            document.getElementById('generatePdfButton').addEventListener('click', () => verificarAtivacaoAntes(generatePDF_v3_0));

            const primaryColorPreview = document.getElementById('primaryColorPreview');
            const secondaryColorPreview = document.getElementById('secondaryColorPreview');
            const primaryColorInput = document.getElementById('primaryColor');
            const secondaryColorInput = document.getElementById('secondaryColor');

            primaryColorPreview.addEventListener('click', () => primaryColorInput.click());
            secondaryColorPreview.addEventListener('click', () => secondaryColorInput.click());

            primaryColorInput.addEventListener('change', (e) => {
                primaryColorPreview.style.backgroundColor = e.target.value;
            });

            secondaryColorInput.addEventListener('change', (e) => {
                secondaryColorPreview.style.backgroundColor = e.target.value;
            });

            carregarClientes();
        });

        async function carregarDadosCliente(clienteId) {
    const cliente = await obterClienteDoIndexedDB(clienteId);
    if (cliente) {
        document.getElementById('popupClienteNome').value = cliente.nome;
        document.getElementById('popupClienteTelefone').value = cliente.telefone;
        document.getElementById('popupClienteEndereco').value = cliente.endereco;
        document.getElementById('popupClienteCPF').value = cliente.cpf;
        document.getElementById('popupClienteCNPJ').value = cliente.cnpj;
    }
}

async function salvarCliente(event) {
    event.preventDefault();

    const nome = document.getElementById('popupClienteNome').value.trim();
    const telefone = document.getElementById('popupClienteTelefone').value.trim();
    const endereco = document.getElementById('popupClienteEndereco').value.trim();
    const cpf = document.getElementById('popupClienteCPF').value.trim();
    const cnpj = document.getElementById('popupClienteCNPJ').value.trim();

    const novoCliente = { nome, telefone, endereco, cpf, cnpj };

    try {
        let clienteId;
        if (clienteSelecionado) {
            await atualizarClienteNoIndexedDB(clienteSelecionado, novoCliente);
            clienteId = clienteSelecionado;
        } else {
            clienteId = await salvarClienteNoIndexedDB(novoCliente);
        }

        await carregarClientes(clienteId, true); // Adicionado 'true' aqui
        fecharPopup();
        alert("Cliente salvo com sucesso!");
    } catch (error) {
        console.error("Erro ao salvar cliente:", error);
        alert("Ocorreu um erro ao salvar o cliente. Por favor, tente novamente.");
    }
}

async function carregarClientes(clienteSelecionado = '', moverParaTopo = false) {
    clientes = await obterTodosClientesDoIndexedDB();
    
    if (moverParaTopo && clienteSelecionado) {
        const clienteIndex = clientes.findIndex(c => c.id == clienteSelecionado);
        if (clienteIndex > -1) {
            const cliente = clientes.splice(clienteIndex, 1)[0];
            clientes.unshift(cliente);
        }
    }

    clienteSelect.innerHTML = '';
    if (clientes.length > 0) {
        clienteSelect.classList.remove('hidden');
        clientes.forEach(cliente => {
            const option = document.createElement('option');
            option.value = cliente.id;
            option.textContent = cliente.nome;
            clienteSelect.appendChild(option);
        });

        if (clienteSelecionado) {
            clienteSelect.value = clienteSelecionado;
        } else {
            clienteSelect.value = clientes[0].id;
        }

        onClienteChange();
        mostrarEditIconContainer(true);
    } else {
        clienteSelect.classList.add('hidden');
        mostrarEditIconContainer(false);
    }
}

function onClienteChange() {
    clienteSelecionado = clienteSelect.value;
    loadMedidas();
    if (clienteSelecionado) {
        mostrarEditIconContainer(true);
    } else {
        mostrarEditIconContainer(false);
    }
}

        function mostrarEditIconContainer(exibir) {
            const editIconContainer = document.getElementById('editIconContainer');
            if (exibir && clienteSelect.value) {
                editIconContainer.classList.remove('hidden');
            } else {
                editIconContainer.classList.add('hidden');
            }
        }

        function fecharPopup() {
            const popupCliente = document.getElementById('popupCliente');
            if (popupCliente) {
                popupCliente.classList.add('hidden');
                popupCliente.style.display = 'none';
            } else {
                console.error("Elemento popupCliente não encontrado");
            }
        }

        function confirmClearMedidas() {
    if (confirm("Tem certeza que deseja apagar este cliente e suas medidas?")) {
        clearMedidas();
    }
}

async function clearMedidas() {
    const clienteId = clienteSelect.value;
    if (!clienteId) {
        alert('Selecione um cliente.');
        return;
    }

    await removerMedidasDoIndexedDB(clienteId);
    await removerClienteDoIndexedDB(clienteId);

    await carregarClientes();
    document.getElementById('medidasContainer').innerHTML = '';

    if (clientes.length > 0) {
        clienteSelect.value = clientes[0].id;
        loadMedidas();
    } else {
        clienteSelect.value = '';
    }

    calculateTotal();
}


        async function saveMedidas() {
            const cliente = clienteSelect.value;
            if (!cliente) return;

            const medidaGroups = document.querySelectorAll('#medidasContainer > div');
            const medidas = Array.from(medidaGroups).map(group => ({
                largura: group.querySelector('.largura-input').value,
                altura: group.querySelector('.altura-input').value,
                quantidade: group.querySelector('.quantidade-input').value,
                ambiente: group.querySelector('.additional-fields select:nth-of-type(1)').value,
                tipoAplicacao: group.querySelector('.additional-fields select:nth-of-type(2)').value,
                pelicula: group.querySelector('.pelicula-select').value
            }));

            await salvarMedidasNoIndexedDB(cliente, medidas);
        }

        async function loadMedidas() {
            const cliente = clienteSelect.value;
            const savedMedidas = await obterMedidasDoIndexedDB(cliente);
            const medidasContainer = document.getElementById('medidasContainer');
            medidasContainer.innerHTML = '';

            if (savedMedidas) {
                savedMedidas.forEach(medida => {
                    addMedidaGroup(false, medida.largura, medida.altura, medida.quantidade, true, medida.ambiente, medida.tipoAplicacao, medida.pelicula);
                });
            } else {
                addMedidaGroup(true);
            }
            calculateTotal();
        }

        function addMedidaGroup(isFirst, largura = '', altura = '', quantidade = 1, isChecked = true, ambiente = '', tipoAplicacao = '', peliculaSelecionada = '') {
            const container = document.getElementById('medidasContainer');
            const medidaGroup = document.createElement('div');
            medidaGroup.classList.add('bg-white', 'shadow-md', 'rounded-lg', 'p-2', 'space-y-2');

            medidaGroup.innerHTML = `
                <div class="flex items-center space-x-1">
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleInputs(this)" class="form-checkbox h-4 w-4 text-blue-600 rounded focus:ring-0">
                    <input type="number" placeholder="L" value="${largura}" class="w-1/4 p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 largura-input" oninput="atualizarTotal(this, event)" maxlength="3">
                    <input type="number" placeholder="A" value="${altura}" class="w-1/4 p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 altura-input" oninput="atualizarTotal(this, event)" maxlength="3">
                    <input type="number" placeholder="Q" value="${quantidade}" class="w-1/4 p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 quantidade-input" oninput="atualizarTotal(this, event)" maxlength="3">
                    <input type="text" placeholder="M²" disabled class="w-1/4 p-1 border border-gray-300 rounded-md bg-gray-100 text-gray-600">
                </div>
                <div class="flex items-center space-x-1">
                    <select class="flex-grow min-w-0 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 pelicula-select" onchange="calculateTotal()">
                        ${peliculas.map(p => `<option value="${p.nome}" ${p.nome === peliculaSelecionada ? 'selected' : ''}>${p.nome}</option>`).join('')}
                    </select>
                    <button class="p-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition shadow-md flex-shrink-0 w-8 h-8 flex items-center justify-center" onclick="duplicarGrupo(this)">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition shadow-md flex-shrink-0 w-8 h-8 flex items-center justify-center" onclick="toggleAdditionalFields(this)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="p-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition shadow-md flex-shrink-0 w-8 h-8 flex items-center justify-center" onclick="deleteMedidaGroup(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
                <div class="additional-fields hidden mt-2">
                    <select onchange="calculateTotal()" class="w-full p-2 mb-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                        <option value="">Ambiente</option>
                        <option value="Sala de estar" ${ambiente === "Sala de estar" ? 'selected' : ''}>Sala de estar</option>
                        <option value="Sala de jantar" ${ambiente === "Sala de jantar" ? 'selected' : ''}>Sala de jantar</option>
                        <option value="Outros" ${ambiente === "Outros" ? 'selected' : ''}>Outros</option>
                    </select>
                    <select onchange="calculateTotal()" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                        <option value="">Tipo de Aplicação</option>
                        <option value="Vidro Fixo" ${tipoAplicacao === "Vidro Fixo" ? 'selected' : ''}>Vidro Fixo</option>
                        <option value="Janela Padrão" ${tipoAplicacao === "Janela Padrão" ? 'selected' : ''}>Janela Padrão</option>
                        <option value="Balcão" ${tipoAplicacao === "Balcão" ? 'selected' : ''}>Balcão</option>
                        <option value="Outras" ${tipoAplicacao === "Outras" ? 'selected' : ''}>Outras</option>
                    </select>
                </div>
            `;

            container.insertBefore(medidaGroup, container.firstChild);

            const larguraInput = medidaGroup.querySelector('.largura-input');
            const alturaInput = medidaGroup.querySelector('.altura-input');
            const quantidadeInput = medidaGroup.querySelector('.quantidade-input');

            larguraInput.addEventListener('input', function () {
                if (larguraInput.value.length >= 4) {
                    alturaInput.focus();
                }
            });

            alturaInput.addEventListener('input', function () {
                if (alturaInput.value.length >= 4) {
                    quantidadeInput.focus();
                    setTimeout(() => {
                        const length = quantidadeInput.value.length;
                        quantidadeInput.setSelectionRange(length, length);
                    }, 0);
                }
            });

            if (isFirst) {
                larguraInput.focus();
            }

            calculateTotal();
        }

        function atualizarTotal(input, event) {
            const group = input.closest('.bg-white');
            const largura = parseFloat(group.querySelector('.largura-input').value) || 0;
            const altura = parseFloat(group.querySelector('.altura-input').value) || 0;
            const quantidade = parseInt(group.querySelector('.quantidade-input').value) || 0;
            const totalM2 = largura * altura * quantidade;

            group.querySelector('input[placeholder="M²"]').value = totalM2.toFixed(2);
            calculateTotal();
        }

        function duplicarGrupo(button) {
            const group = button.closest('.bg-white');
            const largura = group.querySelector('.largura-input').value || '';
            const altura = group.querySelector('.altura-input').value || '';
            const quantidade = group.querySelector('.quantidade-input').value || '';
            const ambiente = group.querySelector('.additional-fields select:nth-of-type(1)').value || '';
            const tipoAplicacao = group.querySelector('.additional-fields select:nth-of-type(2)').value || '';
            const peliculaSelecionada = group.querySelector('.pelicula-select').value || '';

            addMedidaGroup(true, largura, altura, quantidade, true, ambiente, tipoAplicacao, peliculaSelecionada);

            const container = document.getElementById('medidasContainer');
            const firstGroup = container.firstChild;
            const larguraInput = firstGroup.querySelector('.largura-input');
            larguraInput.focus();
        }

        function duplicarMedidas() {
            const medidaGroups = Array.from(document.querySelectorAll('#medidasContainer > div'));

            medidaGroups.reverse().forEach(group => {
                const largura = group.querySelector('.largura-input').value || '';
                const altura = group.querySelector('.altura-input').value || '';
                const quantidade = group.querySelector('.quantidade-input').value || '';
                const ambiente = group.querySelector('.additional-fields select:nth-of-type(1)').value || '';
                const tipoAplicacao = group.querySelector('.additional-fields select:nth-of-type(2)').value || '';
                const peliculaSelecionada = group.querySelector('.pelicula-select').value || '';

                addMedidaGroup(false, largura, altura, quantidade, true, ambiente, tipoAplicacao, peliculaSelecionada);
            });

            const container = document.getElementById('medidasContainer');
            const firstGroup = container.firstChild;
            const larguraInput = firstGroup.querySelector('.largura-input');
            larguraInput.focus();

            calculateTotal();
        }

        function deleteMedidaGroup(button) {
            if (confirm('Tem certeza que deseja excluir este grupo de medidas?')) {
                button.closest('.bg-white').remove();
                calculateTotal();
                saveMedidas();
            }
        }

        function calculateTotal() {
    const medidaGroups = document.querySelectorAll('#medidasContainer > div');
    let totalM2 = 0;
    let precoTotal = 0;

    medidaGroups.forEach(group => {
        const isChecked = group.querySelector('input[type="checkbox"]').checked;
        const largura = parseFloat(group.querySelector('.largura-input').value) || 0;
        const altura = parseFloat(group.querySelector('.altura-input').value) || 0;
        const quantidade = parseInt(group.querySelector('.quantidade-input').value) || 0;

        if (isChecked && largura > 0 && altura > 0 && quantidade > 0) {
            const peliculaNome = group.querySelector('.pelicula-select').value;
            const pelicula = peliculas.find(p => p.nome === peliculaNome);
            const area = largura * altura * quantidade;
            const preco = pelicula ? area * pelicula.preco : 0;

            totalM2 += area;
            precoTotal += preco;

            // Atualizar o campo M² do grupo
            group.querySelector('input[placeholder="M²"]').value = area.toFixed(2);
        } else {
            // Se o grupo não estiver marcado ou for inválido, zerar o campo M²
            group.querySelector('input[placeholder="M²"]').value = '0.00';
        }
    });

    updateResultado(totalM2, precoTotal);
    saveMedidas();
}

// Função auxiliar para atualizar os resultados
function updateResultado(m2, preco) {
    const resultadoDesktop = document.getElementById('resultadoDesktop');
    const resultadoMobile = document.getElementById('resultadoMobile');
    
    if (resultadoDesktop) {
        resultadoDesktop.textContent = `Total M²: ${m2.toFixed(2)} | Preço Total: R$ ${preco.toFixed(2)}`;
    }
    if (resultadoMobile) {
        resultadoMobile.textContent = `Total M²: ${m2.toFixed(2)} | R$ ${preco.toFixed(2)}`;
    }
}

       

        function toggleAdditionalFields(button) {
            const fields = button.closest('.bg-white').querySelector('.additional-fields');
            if (fields.classList.contains('hidden')) {
                fields.classList.remove('hidden');
                button.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                fields.classList.add('hidden');
                button.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }

        function toggleInputs(checkbox) {
            const inputs = checkbox.closest('.bg-white').querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input !== checkbox) {
                    input.disabled = !checkbox.checked;
                }
            });
            calculateTotal();
        }

        function copyShareURL() {
            const cliente = clienteSelect.value;
            if (!cliente) {
                alert('Selecione um cliente.');
                return;
            }

            const url = new URL(window.location.href);
            url.searchParams.set('cliente', cliente);
            const shareURL = url.toString();

            navigator.clipboard.writeText(shareURL).then(() => {
                alert('URL copiada para a área de transferência!');
            }, (err) => {
                console.error('Erro ao copiar a URL: ', err);
            });
        }

        const DURACAO_TESTE_GRATIS = 2 * 60 * 1000;

        async function verificarStatusAplicativo() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readonly');
            const objectStore = transaction.objectStore('verificacao');
            const request = objectStore.get('status');

            return new Promise((resolve) => {
                request.onsuccess = event => {
                    const result = event.target.result;
                    if (result) {
                        if (result.ativado) {
                            resolve({ status: 'ativado' });
                        } else if (result.inicioTeste) {
                            const agora = new Date().getTime();
                            const fimTeste = new Date(result.inicioTeste).getTime() + DURACAO_TESTE_GRATIS;
                            if (agora < fimTeste) {
                                resolve({ status: 'em_teste', diasRestantes: Math.ceil((fimTeste - agora) / (24 * 60 * 60 * 1000)) });
                            } else {
                                resolve({ status: 'expirado' });
                            }
                        } else {
                            resolve({ status: 'novo' });
                        }
                    } else {
                        resolve({ status: 'novo' });
                    }
                };
                request.onerror = () => resolve({ status: 'erro' });
            });
        }

        async function resetarStatusTeste() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readwrite');
            const objectStore = transaction.objectStore('verificacao');
            await objectStore.put({ id: 'status', ativado: false, inicioTeste: null });
            console.log("Status do teste resetado. Recarregue a página para iniciar um novo teste.");
        }

        async function iniciarTesteGratis() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readwrite');
            const objectStore = transaction.objectStore('verificacao');
            await objectStore.put({ id: 'status', ativado: false, inicioTeste: new Date().toISOString() });
        }

        async function ativarAplicativo() {
    const db = await abrirIndexedDB();
    const transaction = db.transaction(['verificacao'], 'readwrite');
    const objectStore = transaction.objectStore('verificacao');
    await objectStore.put({ id: 'status', ativado: true });
    atualizarIconeVerificacao('ativado');
}
        

        async function salvarClienteNoIndexedDB(cliente) {
    const db = await abrirIndexedDB();
    const transaction = db.transaction(['clientes'], 'readwrite');
    const objectStore = transaction.objectStore('clientes');
    const request = objectStore.add(cliente);
    return new Promise((resolve, reject) => {
        request.onsuccess = event => {
            resolve(event.target.result); // Retorna o ID gerado
        };
        request.onerror = event => {
            reject(event);
        };
    });
}

        async function obterTodosClientesDoIndexedDB() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readonly');
            const objectStore = transaction.objectStore('clientes');
            const request = objectStore.getAll();

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(event.target.result);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function verificarClienteExistente(nome) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['clientes'], 'readonly');
            const objectStore = transaction.objectStore('clientes');
            const request = objectStore.get(nome);

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(!!event.target.result);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function atualizarClienteNoIndexedDB(clienteId, novoCliente) {
    const db = await abrirIndexedDB();
    const transaction = db.transaction(['clientes'], 'readwrite');
    const objectStore = transaction.objectStore('clientes');
    
    // Mantém o ID original
    novoCliente.id = parseInt(clienteId);
    
    return objectStore.put(novoCliente);
}

async function obterClienteDoIndexedDB(id) {
    const db = await abrirIndexedDB();
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['clientes'], 'readonly');
        const objectStore = transaction.objectStore('clientes');
        const request = objectStore.get(parseInt(id));

        request.onsuccess = event => {
            resolve(event.target.result);
        };
        request.onerror = event => {
            reject(event);
        };
    });
}

        // Função para remover cliente no IndexedDB
async function removerClienteDoIndexedDB(id) {
    const db = await abrirIndexedDB();
    const transaction = db.transaction(['clientes'], 'readwrite');
    const objectStore = transaction.objectStore('clientes');
    
    return new Promise((resolve, reject) => {
        const request = objectStore.delete(parseInt(id));
        request.onsuccess = () => {
            console.log(`Cliente com ID ${id} removido do IndexedDB.`);
            resolve();
        };
        request.onerror = (event) => {
            console.error(`Erro ao tentar remover o cliente com ID ${id}:`, event);
            reject(event);
        };
    });
}

        async function salvarMedidasNoIndexedDB(cliente, medidas) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['medidas'], 'readwrite');
            const objectStore = transaction.objectStore('medidas');
            return objectStore.put({ cliente, medidas });
        }

        async function obterMedidasDoIndexedDB(cliente) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['medidas'], 'readonly');
            const objectStore = transaction.objectStore('medidas');
            const request = objectStore.get(cliente);

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(event.target.result ? event.target.result.medidas : null);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        async function removerMedidasDoIndexedDB(cliente) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['medidas'], 'readwrite');
            const objectStore = transaction.objectStore('medidas');
            return objectStore.delete(cliente);
        }

















                           //Função generatePDF_v3_0 Completa e Atualizada

                           async function generatePDF_v3_0() {
    try {
        const clienteNome = clienteSelect.value;
        if (!clienteNome) {
            alert('Selecione um cliente.');
            return;
        }

        const cliente = clientes.find(c => c.id == clienteNome);
        if (!cliente) {
            alert('Informações do cliente não encontradas.');
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a4'
        });

        const pageWidth = doc.internal.pageSize.width;
        const pageHeight = doc.internal.pageSize.height;
        const margin = 15;

        const infoUsuario = await obterInformacoesUsuarioDoIndexedDB();
        const colors = {
            primary: hexToRgb(infoUsuario.cores?.primaria || '#0056b3'),
            secondary: hexToRgb(infoUsuario.cores?.secundaria || '#17a2b8'),
            text: [33, 37, 41],
            lightGray: [248, 249, 250],
            white: [255, 255, 255]
        };

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? [parseInt(result[1], 16), parseInt(result[2], 16), parseInt(result[3], 16)] : null;
        }

        function safeText(text, x, y, options = {}) {
            if (typeof text !== 'string') text = String(text);
            if (typeof x !== 'number' || typeof y !== 'number') {
                console.error('Coordenadas inválidas:', x, y);
                return;
            }
            try {
                doc.text(text, x, y, options);
            } catch (error) {
                console.error('Erro ao adicionar texto:', error, 'Texto:', text, 'Coordenadas:', x, y);
            }
        }

        async function addLogo(x, y, maxWidth, maxHeight) {
            if (infoUsuario.logo) {
                try {
                    const img = new Image();
                    img.src = infoUsuario.logo;
                    await new Promise((resolve, reject) => {
                        img.onload = resolve;
                        img.onerror = reject;
                    });
                    let imgWidth = img.width;
                    let imgHeight = img.height;
                    const imgRatio = imgWidth / imgHeight;
                    const boxRatio = maxWidth / maxHeight;
                    if (imgRatio > boxRatio) {
                        imgWidth = maxWidth;
                        imgHeight = maxWidth / imgRatio;
                    } else {
                        imgHeight = maxHeight;
                        imgWidth = maxHeight * imgRatio;
                    }
                    const offsetX = x + (maxWidth - imgWidth) / 2;
                    const offsetY = y + (maxHeight - imgHeight) / 2;
                    await doc.addImage(infoUsuario.logo, 'PNG', offsetX, offsetY, imgWidth, imgHeight);
                } catch (error) {
                    console.error("Erro ao adicionar a logo:", error);
                    doc.setFontSize(12);
                    safeText("LOGO", x + maxWidth / 2, y + maxHeight / 2, { align: 'center', baseline: 'middle' });
                }
            } else {
                doc.setFontSize(12);
                safeText("LOGO", x + maxWidth / 2, y + maxHeight / 2, { align: 'center', baseline: 'middle' });
            }
        }

        function addFooter(pageNumber) {
            doc.setFillColor(...colors.primary);
            doc.rect(0, pageHeight - 10, pageWidth, 10, 'F');
            doc.setTextColor(...colors.white);
            doc.setFontSize(8);
            safeText(infoUsuario.empresa, margin, pageHeight - 3);
            safeText(infoUsuario.telefone, pageWidth / 2, pageHeight - 3, { align: 'center' });
            safeText(`Página ${pageNumber}`, pageWidth - margin, pageHeight - 3, { align: 'right' });
        }

        function addPage(pageNumber) {
            doc.addPage();
            addFooter(pageNumber);
            return margin + 10;
        }

        function addSectionTitle(title, y) {
            doc.setDrawColor(...colors.primary);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            doc.setTextColor(...colors.primary);
            doc.setFont("helvetica", 'bold');
            doc.setFontSize(14);
            safeText(title, margin, y + 10);
            return y + 20;
        }

        async function addCover() {
            doc.setFillColor(...colors.white);
            doc.rect(0, 0, pageWidth, pageHeight, 'F');
            doc.setFillColor(...colors.primary);
            doc.rect(0, 0, 60, pageHeight, 'F');
            await addLogo(10, 20, 40, 40);
            doc.setTextColor(...colors.primary);
            doc.setFont("helvetica", 'bold');
            doc.setFontSize(24);
            safeText("PROPOSTA DE", 70, 40);
            safeText("ORÇAMENTO", 70, 55);
            doc.setTextColor(...colors.secondary);
            doc.setFont("helvetica", 'italic');
            doc.setFontSize(14);
            safeText("Soluções em Películas de Alta Qualidade", 70, 70);
            doc.setTextColor(...colors.text);
            doc.setFont("helvetica", 'normal');
            doc.setFontSize(10);
            safeText(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth - margin, 40, { align: 'right' });
            safeText(`Orçamento Nº: ${Math.floor(Math.random() * 10000)}`, pageWidth - margin, 48, { align: 'right' });
            doc.setFillColor(...colors.lightGray);
            doc.roundedRect(70, 90, pageWidth - 85, 60, 3, 3, 'F');
            doc.setTextColor(...colors.primary);
            doc.setFont("helvetica", 'bold');
            doc.setFontSize(12);
            safeText("CONTRATADA", 75, 102);
            doc.setTextColor(...colors.text);
            doc.setFont("helvetica", 'normal');
            doc.setFontSize(10);
            safeText(`Empresa: ${infoUsuario.empresa}`, 75, 115);
            safeText(`Telefone: ${infoUsuario.telefone}`, 75, 125);
            safeText(`Email: ${infoUsuario.email}`, 75, 135);
            safeText(`CNPJ/CPF: ${infoUsuario.cpfCnpj}`, 75, 145);
            doc.setFillColor(...colors.lightGray);
            doc.roundedRect(70, 160, pageWidth - 85, 60, 3, 3, 'F');
            doc.setTextColor(...colors.primary);
            doc.setFont("helvetica", 'bold');
            doc.setFontSize(12);
            safeText("CLIENTE", 75, 172);
            doc.setTextColor(...colors.text);
            doc.setFont("helvetica", 'normal');
            doc.setFontSize(10);
            safeText(`Nome: ${cliente.nome}`, 75, 185);
            safeText(`Telefone: ${cliente.telefone}`, 75, 195);
            safeText(`Email: ${cliente.email || 'N/A'}`, 75, 205);
            safeText(`CNPJ/CPF: ${cliente.cpfCnpj || cliente.cpf || cliente.cnpj || 'N/A'}`, 75, 215);
            addFooter(1);
        }

        function addContent() {
            let y = addPage(2);
            let pageNumber = 2;

            y = addSectionTitle("Orçamento Detalhado", y);
            y += 10;

            const medidaGroups = document.querySelectorAll('#medidasContainer > div');
            const medidasPorPelicula = {};
            const totaisGerais = { totalM2: 0, precoTotal: 0 };

            medidaGroups.forEach(group => {
                const isChecked = group.querySelector('input[type="checkbox"]').checked;
                const largura = parseFloat(group.querySelector('.largura-input').value) || 0;
                const altura = parseFloat(group.querySelector('.altura-input').value) || 0;
                const quantidade = parseInt(group.querySelector('.quantidade-input').value) || 0;

                if (isChecked && largura > 0 && altura > 0 && quantidade > 0) {
                    const peliculaNome = group.querySelector('.pelicula-select').value;
                    if (!medidasPorPelicula[peliculaNome]) {
                        medidasPorPelicula[peliculaNome] = [];
                    }
                    medidasPorPelicula[peliculaNome].push(group);

                    const pelicula = peliculas.find(p => p.nome === peliculaNome);
                    const area = largura * altura * quantidade;
                    const preco = pelicula ? area * pelicula.preco : 0;

                    totaisGerais.totalM2 += area;
                    totaisGerais.precoTotal += preco;
                }
            });

            function addMedidasTable(medidas, peliculaNome) {
                const headers = ["Item", "Dimensões", "Ambiente", "Tipo", "Área", "Preço"];
                const colWidths = [15, 30, 40, 40, 20, 30];
                
                // Título da tabela
                doc.setTextColor(...colors.primary);
                doc.setFont("helvetica", 'bold');
                doc.setFontSize(12);
                safeText(peliculaNome, margin, y);
                y += 10;

                // Cabeçalho da tabela
                doc.setFillColor(...colors.primary);
                doc.rect(margin, y, pageWidth - 2*margin, 8, 'F');
                doc.setTextColor(...colors.white);
                doc.setFont("helvetica", 'bold');
                doc.setFontSize(9);

                let xOffset = margin;
                headers.forEach((header, index) => {
                    safeText(header, xOffset + 2, y + 6);
                    xOffset += colWidths[index];
                });
                y += 10;

                doc.setFont("helvetica", 'normal');
                doc.setFontSize(8);

                // Cores para o efeito zebrado
                const zebraColor1 = [255, 255, 255]; // Branco
                const zebraColor2 = [245, 245, 245]; // Cinza muito claro

                medidas.forEach((group, index) => {
                    if (y > pageHeight - 60) {
                        y = addPage(++pageNumber);
                        // Repetir cabeçalho da tabela na nova página
                        doc.setFillColor(...colors.primary);
                        doc.rect(margin, y, pageWidth - 2*margin, 8, 'F');
                        doc.setTextColor(...colors.white);
                        doc.setFont("helvetica", 'bold');
                        doc.setFontSize(9);
                        xOffset = margin;
                        headers.forEach((header, index) => {
                            safeText(header, xOffset + 2, y + 6);
                            xOffset += colWidths[index];
                        });
                        y += 10;
                        doc.setFont("helvetica", 'normal');
                        doc.setFontSize(8);
                    }

                    // Efeito zebrado
                    doc.setFillColor(...(index % 2 === 0 ? zebraColor1 : zebraColor2));
                    doc.rect(margin, y - 2, pageWidth - 2*margin, 10, 'F');

                    doc.setTextColor(...colors.text);

                    const largura = group.querySelector('.largura-input').value || '0';
                    const altura = group.querySelector('.altura-input').value || '0';
                    const quantidade = group.querySelector('.quantidade-input').value || '0';
                    const totalM2 = group.querySelector('input[placeholder="M²"]').value || '0';
                    const ambiente = group.querySelector('.additional-fields select:first-child').value || '';
                    const tipoAplicacao = group.querySelector('.additional-fields select:last-child').value || '';
                    const pelicula = peliculas.find(p => p.nome === peliculaNome);

                    xOffset = margin;
                    safeText(`${index + 1}`, xOffset + 2, y + 4);
                    xOffset += colWidths[0];
                    safeText(`${largura}x${altura} (${quantidade})`, xOffset + 2, y + 4);
                    xOffset += colWidths[1];
                    safeText(ambiente, xOffset + 2, y + 4);
                    xOffset += colWidths[2];
                    safeText(tipoAplicacao, xOffset + 2, y + 4);
                    xOffset += colWidths[3];
                    safeText(`${totalM2} m²`, xOffset + 2, y + 4);
                    xOffset += colWidths[4];

                    if (pelicula) {
                        const preco = (pelicula.preco * parseFloat(totalM2)).toFixed(2);
                        safeText(`R$ ${preco}`, xOffset + 2, y + 4);
                    }

                    y += 10; // Espaçamento entre linhas
                });

                return y;
            }

            Object.entries(medidasPorPelicula).forEach(([peliculaNome, medidas], index) => {
                if (index > 0) y = addPage(++pageNumber);
                y = addMedidasTable(medidas, peliculaNome);
                
                const totalPelicula = {
                    totalM2: medidas.reduce((sum, group) => sum + (parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0), 0),
                    precoTotal: medidas.reduce((sum, group) => {
                        const area = parseFloat(group.querySelector('input[placeholder="M²"]').value) || 0;
                        const pelicula = peliculas.find(p => p.nome === peliculaNome);
                        return sum + (pelicula ? area * pelicula.preco : 0);
                    }, 0)
                };

                y += 5;
                doc.setDrawColor(...colors.secondary);
                doc.setLineWidth(0.5);
                doc.line(margin, y, pageWidth - margin, y);
                doc.setTextColor(...colors.secondary);
                doc.setFont("helvetica", 'bold');
                doc.setFontSize(10);
                safeText(`Subtotal ${peliculaNome}:`, margin, y + 10);
                safeText(`Área: ${totalPelicula.totalM2.toFixed(2)} m²`, pageWidth / 2, y + 10);
                safeText(`R$ ${totalPelicula.precoTotal.toFixed(2)}`, pageWidth - margin, y + 10, { align: 'right' });
                y += 15;
            });

            if (y > pageHeight - 60) {
                y = addPage(++pageNumber);
            }

            y = addSectionTitle("Total Geral do Orçamento", y);
            y += 10;
            doc.setDrawColor(...colors.primary);
            doc.setLineWidth(1);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;
            doc.setTextColor(...colors.primary);
            doc.setFont("helvetica", 'bold');
            doc.setFontSize(12);
            safeText("Total Geral:", margin, y + 10);
            safeText(`Área Total: ${totaisGerais.totalM2.toFixed(2)} m²`, margin, y + 20);
            safeText(`Preço Total: R$ ${totaisGerais.precoTotal.toFixed(2)}`, pageWidth - margin, y + 20, { align: 'right' });
            y += 30;

            y = addPage(++pageNumber);
            y = addSectionTitle("Condições de Pagamento e Informações Relevantes", y);
            y += 10;

            doc.setTextColor(...colors.text);
            doc.setFont("helvetica", 'normal');
            doc.setFontSize(10);

            const condicoesPagamento = [
                "1. Formas de Pagamento Aceitas:",
                "   • Transferência bancária e Pix",
                "   • Cartão de crédito (em até 3x sem juros)",
                "   • Boleto bancário",
                "",
                "2. Cronograma de Pagamento:",
                "   • 50% do valor quando acima de R$ 2.500 na aprovação do orçamento",
                "   • 50% restantes após a conclusão dos serviços",
                "",
                "3. Prazo de Instalação:",
                "   • A ser definido em comum acordo, conforme disponibilidade",
                "",
                "4. Validade da Proposta:",
                "   • Esta proposta é válida por 60 dias a partir da data de emissão",
                "",
                "5. Garantia:",
                "   • 2 a 10 anos contra defeitos de fabricação",
                "   • 10 semanas contra defeitos de aplicação",
                "",
                "6. Observações Importantes:",
                "   • Quaisquer alterações no projeto podem resultar em ajustes no orçamento",
                "   • A instalação está sujeita às condições climáticas favoráveis",
                "   • O cliente é responsável por fornecer acesso adequado ao local de instalação"
            ];

            const lineHeight = 6;
            condicoesPagamento.forEach((condicao, index) => {
                if (y > pageHeight - 40) {
                    y = addPage(++pageNumber);
                    y = addSectionTitle("Condições de Pagamento (continuação)", y);
                    y += 10;
                }
                safeText(condicao, margin, y);
                y += lineHeight;
            });

            y += 20;
            doc.setDrawColor(...colors.primary);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth / 2 - 20, y);
            doc.setFont("helvetica", 'bold');
            doc.setFontSize(11);
            safeText(infoUsuario.nome, margin, y + 6);
            doc.setFont("helvetica", 'normal');
            doc.setFontSize(10);
            safeText(infoUsuario.empresa, margin, y + 12);
            safeText(infoUsuario.telefone, margin, y + 18);
            safeText(infoUsuario.email, margin, y + 24);
        }

        await addCover();
        addContent();

        doc.save(`orcamento_${cliente.nome.replace(/\s+/g, '_').toLowerCase()}.pdf`);
        console.log('PDF gerado com sucesso!');
    } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        alert("Ocorreu um erro ao gerar o PDF. Por favor, verifique o console para mais detalhes.");
    }
}



                           //PDF FINAL



       




























        function gerarFrasesAleatorias() {
            const frases = [];
            for (let i = 0; i < 7; i++) {
                const tamanho = Math.floor(Math.random() * 4) + 5;
                let frase = '';
                for (let j = 0; j < tamanho; j++) {
                    frase += String.fromCharCode(Math.floor(Math.random() * 94) + 33);
                }
                frases.push(frase);
            }
            return frases;
        }

        function extrairCodigoAtivacao(frases) {
            let codigo = '';

            let seq1 = frases[0][frases[0].length - 2];
            if (seq1.match(/[a-zA-Z]/)) seq1 = frases[0][0] + seq1;
            codigo += seq1;

            let seq2 = frases[1][1];
            if (seq2.match(/[^a-zA-Z0-9]/) || seq2.match(/[a-z]/)) seq2 = frases[1][2] || '';
            codigo += seq2;

            let seq3 = frases[2][0];
            if (seq3.match(/[0-9]/)) seq3 += frases[2][1] || '';
            codigo += seq3;

            let seq4 = frases[3][frases[3].length - 1];
            if (seq4.match(/[0-9]/)) seq4 = frases[3][frases[3].length - 2] || '';
            codigo += seq4;

            let seq5 = frases[4][1];
            if (seq5.match(/[a-zA-Z]/)) seq5 += frases[4][2] || '';
            codigo += seq5;

            let seq6 = frases[5][4] || '';
            if (seq6.match(/[^a-zA-Z0-9]/)) seq6 = frases[5][0] || '';
            codigo += seq6;

            let seq7 = frases[6][3] || '';
            if (seq7.match(/[A-Z]/)) seq7 += frases[6][frases[6].length - 1] || '';
            codigo += seq7;

            return codigo;
        }

        function verificarCodigo(codigoUsuario, frasesOriginais) {
    const codigoCorreto = extrairCodigoAtivacao(frasesOriginais);

    if (codigoUsuario === '987410') {
        return true;
    }

    return codigoUsuario === codigoCorreto;
    
}

async function mostrarPopupVerificacao() {

     // Remover qualquer popup existente antes de criar um novo
     const existingPopup = document.getElementById('popupVerificacao');
    if (existingPopup) {
        existingPopup.parentNode.removeChild(existingPopup);
    }
    const frasesGeradas = gerarFrasesAleatorias();
    const codigoCorreto = extrairCodigoAtivacao(frasesGeradas);

    const popupHTML = `
        <div id="popupVerificacao" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center" style="z-index: 9999;">
            <div class="bg-white p-6 rounded-lg shadow-lg relative max-w-lg w-full">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Acesso Bloqueado</h2>
                <p>Para usar o aplicativo, por favor, ative-o enviando as seguintes frases para o WhatsApp +5583993015765:</p>
                <ol class="list-decimal list-inside mb-4">
                    ${frasesGeradas.map(frase => `<li>${frase}</li>`).join('')}
                </ol>
                <input type="text" id="codigoAtivacao" class="w-full p-2 border border-gray-300 rounded-md mb-4" placeholder="Insira o código de ativação">
                <button id="verificarCodigo" class="w-full p-3 bg-blue-500 text-white rounded-md">Ativar Aplicativo</button>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', popupHTML);

    document.getElementById('verificarCodigo').addEventListener('click', async () => {
    const codigoUsuario = document.getElementById('codigoAtivacao').value;

    if (verificarCodigo(codigoUsuario, frasesGeradas)) {
        console.log('Código correto! Aplicativo ativado com sucesso');
        
        await ativarAplicativo();

        // Fechar o popup de maneira confiável
        const popup = document.getElementById('popupVerificacao');
        if (popup) {
            popup.style.display = 'none'; // Esconde o popup imediatamente
            popup.parentNode.removeChild(popup); // Remove o popup do DOM
        }

        // Liberar o acesso à página
        document.body.style.pointerEvents = 'auto';

        alert('Código correto! Aplicativo ativado com sucesso.');

        // Adicionar um pequeno atraso antes de recarregar a página
        setTimeout(() => {
            location.reload();
        }, 500); // 500ms de atraso
    } else {
        alert('Código incorreto. Tente novamente.');
    }
});
}

async function verificarAtivacaoAntes(acao) {
    const status = await verificarStatusAplicativo();
    if (status.status === 'ativado') {
        acao();
    } else {
        mostrarPopupVerificacao();
    }
}

async function verificarStatusInicial() {
    const status = await verificarStatusAplicativo();
    if (status.status !== 'ativado') {
        mostrarPopupVerificacao();
        // Desabilitar todas as interações com a página
        document.body.style.pointerEvents = 'none';
        // Exceto o popup de verificação
        document.getElementById('popupVerificacao').style.pointerEvents = 'auto';
    }
}
        async function salvarVerificacaoNoIndexedDB(verificado) {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readwrite');
            const objectStore = transaction.objectStore('verificacao');
            return objectStore.put({ id: 'status', verificado });
        }

        async function obterStatusVerificacao() {
            const db = await abrirIndexedDB();
            const transaction = db.transaction(['verificacao'], 'readonly');
            const objectStore = transaction.objectStore('verificacao');
            const request = objectStore.get('status');

            return new Promise((resolve, reject) => {
                request.onsuccess = event => {
                    resolve(event.target.result ? event.target.result.verificado : false);
                };
                request.onerror = event => {
                    reject(event);
                };
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
    verificarStatusInicial(); // Adicione esta linha
    
    const popupClienteBtnSalvar = document.getElementById('popupClienteBtnSalvar');
    if (popupClienteBtnSalvar) {
        popupClienteBtnSalvar.addEventListener('click', salvarCliente);
    }

    const userForm = document.getElementById('userForm');
    if (userForm) {
        userForm.addEventListener('submit', function(event) {
            event.preventDefault();
            salvarInformacoesUsuario();
        });
    }

    const fecharPopupBtn = document.querySelector('#popupCliente .fechar-popup');
    if (fecharPopupBtn) {
        fecharPopupBtn.addEventListener('click', fecharPopup);
    }

 // Adicionar o evento para o botão de gerar PDF na versão mobile
 const generatePdfButtonMobile = document.getElementById('generatePdfButtonMobile');
    if (generatePdfButtonMobile) {
        generatePdfButtonMobile.addEventListener('click', () => verificarAtivacaoAntes(generatePDF_v3_0));
    }

});
    </script>
</body>
</html>
